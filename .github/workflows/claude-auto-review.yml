name: Claude Auto Review PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

jobs:
  # å…ˆè¿è¡Œè‡ªåŠ¨åŒ–æ£€æŸ¥
  automated-checks:
    name: Automated Quality Checks
    runs-on: ubuntu-latest

    outputs:
      checks_passed: ${{ steps.final-check.outputs.passed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm run install:all

      - name: Run linters
        id: lint
        continue-on-error: true
        run: |
          echo "Running server linter..."
          cd server && npm run lint
          SERVER_LINT=$?

          echo "Running client linter..."
          cd ../client && npm run lint
          CLIENT_LINT=$?

          if [ $SERVER_LINT -eq 0 ] && [ $CLIENT_LINT -eq 0 ]; then
            echo "result=passed" >> $GITHUB_OUTPUT
          else
            echo "result=failed" >> $GITHUB_OUTPUT
          fi

      - name: Run type checks
        id: typecheck
        continue-on-error: true
        run: |
          echo "Type checking server..."
          cd server && npx tsc --noEmit
          SERVER_TYPE=$?

          echo "Type checking client..."
          cd ../client && npx tsc --noEmit
          CLIENT_TYPE=$?

          if [ $SERVER_TYPE -eq 0 ] && [ $CLIENT_TYPE -eq 0 ]; then
            echo "result=passed" >> $GITHUB_OUTPUT
          else
            echo "result=failed" >> $GITHUB_OUTPUT
          fi

      - name: Run tests
        id: test
        continue-on-error: true
        run: |
          echo "Running server tests..."
          cd server && npm test
          SERVER_TEST=$?

          echo "Running client tests..."
          cd ../client && npm test -- --watchAll=false
          CLIENT_TEST=$?

          if [ $SERVER_TEST -eq 0 ] && [ $CLIENT_TEST -eq 0 ]; then
            echo "result=passed" >> $GITHUB_OUTPUT
          else
            echo "result=failed" >> $GITHUB_OUTPUT
          fi

      - name: Final check result
        id: final-check
        run: |
          if [ "${{ steps.lint.outputs.result }}" = "passed" ] && \
             [ "${{ steps.typecheck.outputs.result }}" = "passed" ] && \
             [ "${{ steps.test.outputs.result }}" = "passed" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… All automated checks passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Some checks failed"
          fi

  # Claude è‡ªåŠ¨å®¡æŸ¥
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    needs: automated-checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿æ¯”è¾ƒ

      - name: Get PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            return {
              number: pr.number,
              title: pr.title,
              body: pr.body,
              author: pr.user.login,
              base: pr.base.ref,
              head: pr.head.ref,
              files_changed: pr.changed_files,
              additions: pr.additions,
              deletions: pr.deletions
            };

      - name: Get file changes
        id: changes
        run: |
          echo "Getting changed files..."

          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > changed_files.txt

          echo "Changed files:"
          cat changed_files.txt

          # è·å–ä»£ç å·®å¼‚
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > code_diff.txt

      - name: Analyze code quality
        id: analysis
        run: |
          echo "Analyzing code quality..."

          # ç»Ÿè®¡ä»£ç å˜æ›´
          ADDITIONS=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | awk '{sum+=$1} END {print sum}')
          DELETIONS=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | awk '{sum+=$2} END {print sum}')
          FILES_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | wc -l)

          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT

          # æ£€æŸ¥æ˜¯å¦æ˜¯å¤§å‹ PR
          if [ $FILES_CHANGED -gt 50 ] || [ $ADDITIONS -gt 1000 ]; then
            echo "is_large_pr=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ This is a large PR"
          else
            echo "is_large_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Claude Review Preparation
        id: claude-prep
        run: |
          cat << 'EOF' > review_prompt.md
          # Claude Code Review Request

          ## PR Information
          - **PR #**: ${{ github.event.pull_request.number }}
          - **Title**: ${{ github.event.pull_request.title }}
          - **Author**: ${{ github.event.pull_request.user.login }}
          - **Files Changed**: ${{ steps.analysis.outputs.files_changed }}
          - **Lines Added**: ${{ steps.analysis.outputs.additions }}
          - **Lines Deleted**: ${{ steps.analysis.outputs.deletions }}

          ## Automated Checks Status
          - **All Checks Passed**: ${{ needs.automated-checks.outputs.checks_passed }}

          ## Review Requirements

          Please review this PR and check:

          ### 1. Code Quality
          - [ ] Code follows project conventions (see CLAUDE.md)
          - [ ] TypeScript types are properly defined
          - [ ] Functions have appropriate comments
          - [ ] No code duplication
          - [ ] Clean and readable code

          ### 2. Security
          - [ ] No SQL injection vulnerabilities
          - [ ] No XSS vulnerabilities
          - [ ] No CSRF vulnerabilities
          - [ ] Input validation is complete
          - [ ] Sensitive data is properly handled
          - [ ] No hardcoded secrets/passwords

          ### 3. Performance
          - [ ] No obvious performance bottlenecks
          - [ ] Database queries are optimized
          - [ ] Proper use of caching
          - [ ] No memory leaks

          ### 4. Testing
          - [ ] Test coverage > 80%
          - [ ] Tests cover main scenarios
          - [ ] Tests cover error cases
          - [ ] Tests are meaningful

          ### 5. Architecture
          - [ ] Code structure is reasonable
          - [ ] Follows separation of concerns
          - [ ] Reusable components/functions
          - [ ] Proper error handling

          ## Review Decision

          Based on your review, decide:

          - **âœ… APPROVE**: All checks passed, code quality is good
          - **ğŸ’¬ COMMENT**: Minor issues, suggestions for improvement
          - **âŒ REQUEST_CHANGES**: Issues must be fixed before merging

          ## Review Output Format

          Please provide:
          1. Overall assessment (APPROVE/COMMENT/REQUEST_CHANGES)
          2. Detailed findings (if any)
          3. Suggestions for improvement
          4. Critical issues that must be fixed (if REQUEST_CHANGES)

          EOF

          echo "Review prompt prepared"

      - name: Post Claude Review Request Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const comment = `## ğŸ¤– Claude Code Review Request

            æ‚¨çš„ PR å·²è§¦å‘ Claude è‡ªåŠ¨ä»£ç å®¡æŸ¥ã€‚

            ### ğŸ“Š PR ç»Ÿè®¡
            - æ–‡ä»¶å˜æ›´: ${{ steps.analysis.outputs.files_changed }}
            - æ–°å¢è¡Œæ•°: ${{ steps.analysis.outputs.additions }}
            - åˆ é™¤è¡Œæ•°: ${{ steps.analysis.outputs.deletions }}

            ### âœ… è‡ªåŠ¨åŒ–æ£€æŸ¥
            - æ‰€æœ‰æ£€æŸ¥é€šè¿‡: ${{ needs.automated-checks.outputs.checks_passed }}

            ### ğŸ” Claude å®¡æŸ¥ä¸­...

            Claude æ­£åœ¨å®¡æŸ¥æ‚¨çš„ä»£ç ï¼Œè¯·ç¨å€™...

            **å®¡æŸ¥å†…å®¹åŒ…æ‹¬ï¼š**
            - âœ… ä»£ç è´¨é‡å’Œè§„èŒƒ
            - âœ… å®‰å…¨æ€§æ£€æŸ¥
            - âœ… æ€§èƒ½ä¼˜åŒ–å»ºè®®
            - âœ… æµ‹è¯•è¦†ç›–ç‡
            - âœ… æ¶æ„åˆç†æ€§

            ---

            **æ³¨æ„**: å¦‚æœæ‚¨çš„ PR æ²¡æœ‰é€šè¿‡ Claude å®¡æŸ¥ï¼Œè¯·æ ¹æ®åé¦ˆä¿®æ”¹ä»£ç å¹¶é‡æ–°æäº¤ã€‚

            ### ğŸ“ æ‰‹åŠ¨è§¦å‘ Claude å®¡æŸ¥

            å¦‚æœæ‚¨æƒ³æ‰‹åŠ¨è¿›è¡Œ Claude å®¡æŸ¥ï¼Œè¯·åœ¨æœ¬åœ°è¿è¡Œï¼š

            \`\`\`bash
            claude

            # åœ¨ Claude Code CLI ä¸­
            /code-review
            \`\`\`

            æˆ–è€…ï¼š

            \`\`\`bash
            # å®¡æŸ¥ PR #${{ github.event.pull_request.number }}
            è¯·å®¡æŸ¥ PR #${{ github.event.pull_request.number }} çš„ä»£ç 
            é‡ç‚¹æ£€æŸ¥ï¼šä»£ç è´¨é‡ã€å®‰å…¨æ€§ã€æ€§èƒ½ã€æµ‹è¯•è¦†ç›–ç‡
            \`\`\`

            ---

            *è‡ªåŠ¨åŒ–æ£€æŸ¥çŠ¶æ€: ${{ needs.automated-checks.outputs.checks_passed == 'true' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

      - name: Claude Review Decision
        id: decision
        run: |
          # è¿™é‡Œæ˜¯æ¨¡æ‹Ÿ Claude çš„å†³ç­–é€»è¾‘
          # å®é™…ä½¿ç”¨æ—¶ï¼Œéœ€è¦é›†æˆ Claude API æˆ–äººå·¥ä»‹å…¥

          echo "Making review decision..."

          # å¦‚æœè‡ªåŠ¨åŒ–æ£€æŸ¥å¤±è´¥ï¼Œç›´æ¥æ‹’ç»
          if [ "${{ needs.automated-checks.outputs.checks_passed }}" != "true" ]; then
            echo "decision=REQUEST_CHANGES" >> $GITHUB_OUTPUT
            echo "reason=è‡ªåŠ¨åŒ–æ£€æŸ¥æœªé€šè¿‡" >> $GITHUB_OUTPUT
            exit 0
          fi

          # å¦‚æœæ˜¯å¤§å‹ PRï¼Œéœ€è¦æ›´ä»”ç»†å®¡æŸ¥
          if [ "${{ steps.analysis.outputs.is_large_pr }}" = "true" ]; then
            echo "decision=COMMENT" >> $GITHUB_OUTPUT
            echo "reason=PR è§„æ¨¡è¾ƒå¤§ï¼Œå»ºè®®æ‹†åˆ†" >> $GITHUB_OUTPUT
            exit 0
          fi

          # é»˜è®¤éœ€è¦äººå·¥å®¡æŸ¥
          echo "decision=COMMENT" >> $GITHUB_OUTPUT
          echo "reason=è¯·ç­‰å¾… Claude äººå·¥å®¡æŸ¥" >> $GITHUB_OUTPUT

      - name: Post Review Result
        uses: actions/github-script@v7
        with:
          script: |
            const decision = '${{ steps.decision.outputs.decision }}';
            const reason = '${{ steps.decision.outputs.reason }}';

            let emoji = 'ğŸ’¬';
            let status = 'éœ€è¦å®¡æŸ¥';
            let action = 'è¯·ç­‰å¾…è¿›ä¸€æ­¥å®¡æŸ¥';

            if (decision === 'APPROVE') {
              emoji = 'âœ…';
              status = 'å®¡æŸ¥é€šè¿‡';
              action = 'ä»£ç è´¨é‡è‰¯å¥½ï¼Œå¯ä»¥åˆå¹¶';
            } else if (decision === 'REQUEST_CHANGES') {
              emoji = 'âŒ';
              status = 'éœ€è¦ä¿®æ”¹';
              action = 'è¯·æ ¹æ®ä»¥ä¸‹åé¦ˆä¿®æ”¹ä»£ç ';
            }

            const comment = `## ${emoji} Claude Code Review Result

            **å®¡æŸ¥çŠ¶æ€**: ${status}

            **åŸå› **: ${reason}

            ### ${action}

            ${decision === 'REQUEST_CHANGES' ? `
            ### ğŸ”§ éœ€è¦ä¿®æ”¹çš„é—®é¢˜

            - è‡ªåŠ¨åŒ–æ£€æŸ¥æœªé€šè¿‡
            - è¯·æ£€æŸ¥ Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
            - ä¿®å¤é—®é¢˜åé‡æ–°æäº¤

            ### ğŸ“ ä¿®å¤æ­¥éª¤

            1. æœ¬åœ°è¿è¡Œæµ‹è¯•: \`npm test\`
            2. è¿è¡Œä»£ç æ£€æŸ¥: \`npm run lint\`
            3. ä¿®å¤æ‰€æœ‰é”™è¯¯
            4. é‡æ–°æäº¤å¹¶æ¨é€
            ` : ''}

            ${decision === 'COMMENT' ? `
            ### ğŸ’¡ å®¡æŸ¥å»ºè®®

            - PR è§„æ¨¡: ${{ steps.analysis.outputs.files_changed }} ä¸ªæ–‡ä»¶ï¼Œ${{ steps.analysis.outputs.additions }} è¡Œæ–°å¢
            ${steps.analysis.outputs.is_large_pr === 'true' ? '- âš ï¸ PR è¾ƒå¤§ï¼Œå»ºè®®æ‹†åˆ†æˆæ›´å°çš„ PR' : ''}
            - è¯·ç¡®ä¿æ‰€æœ‰è‡ªåŠ¨åŒ–æ£€æŸ¥é€šè¿‡
            - å»ºè®®è¿›è¡Œäººå·¥ä»£ç å®¡æŸ¥

            ### ğŸ” ä¸‹ä¸€æ­¥

            åœ¨æœ¬åœ°ä½¿ç”¨ Claude è¿›è¡Œè¯¦ç»†å®¡æŸ¥ï¼š

            \`\`\`bash
            claude
            # è¾“å…¥ï¼š/code-review
            \`\`\`
            ` : ''}

            ---
            *è‡ªåŠ¨å®¡æŸ¥å®Œæˆæ—¶é—´: ${new Date().toISOString()}*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

            // å¦‚æœéœ€è¦ä¿®æ”¹ï¼Œè®¾ç½® PR çŠ¶æ€ä¸º requested changes
            if (decision === 'REQUEST_CHANGES') {
              // æ·»åŠ  needs-changes label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: ['needs-changes', 'claude-review']
              });
            } else if (decision === 'APPROVE') {
              // æ·»åŠ  approved label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: ['approved', 'claude-review']
              });
            }

  # å†³å®šæ˜¯å¦è‡ªåŠ¨åˆå¹¶
  auto-merge:
    name: Auto Merge Decision
    runs-on: ubuntu-latest
    needs: [automated-checks, claude-review]
    if: needs.automated-checks.outputs.checks_passed == 'true'

    steps:
      - name: Check if should auto-merge
        id: should-merge
        run: |
          # åªæœ‰å½“æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡æ—¶æ‰è€ƒè™‘è‡ªåŠ¨åˆå¹¶
          # å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„é€»è¾‘

          echo "Checking if PR should be auto-merged..."

          # é»˜è®¤ä¸è‡ªåŠ¨åˆå¹¶ï¼Œéœ€è¦äººå·¥ç¡®è®¤
          echo "auto_merge=false" >> $GITHUB_OUTPUT
          echo "reason=éœ€è¦äººå·¥ç¡®è®¤ååˆå¹¶" >> $GITHUB_OUTPUT

      - name: Post auto-merge status
        uses: actions/github-script@v7
        with:
          script: |
            const shouldMerge = '${{ steps.should-merge.outputs.auto_merge }}' === 'true';

            const comment = `## ğŸ”€ è‡ªåŠ¨åˆå¹¶çŠ¶æ€

            ${shouldMerge ? `
            âœ… **æ­¤ PR æ»¡è¶³è‡ªåŠ¨åˆå¹¶æ¡ä»¶**

            - æ‰€æœ‰è‡ªåŠ¨åŒ–æ£€æŸ¥é€šè¿‡
            - Claude å®¡æŸ¥é€šè¿‡

            PR å°†åœ¨ 5 åˆ†é’Ÿåè‡ªåŠ¨åˆå¹¶ã€‚
            ` : `
            â¸ï¸ **æ­¤ PR éœ€è¦äººå·¥ç¡®è®¤**

            è™½ç„¶æ‰€æœ‰æ£€æŸ¥å·²é€šè¿‡ï¼Œä½†ä»éœ€äººå·¥ç¡®è®¤åæ‰èƒ½åˆå¹¶ã€‚

            **ç¡®è®¤æ­¥éª¤**ï¼š
            1. ä»”ç»†å®¡æŸ¥ä»£ç å˜æ›´
            2. ç¡®è®¤åŠŸèƒ½ç¬¦åˆé¢„æœŸ
            3. ç‚¹å‡» "Merge pull request" æŒ‰é’®
            `}

            ---
            *æ£€æŸ¥æ—¶é—´: ${new Date().toISOString()}*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
