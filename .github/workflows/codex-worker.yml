name: Codex Worker

on:
  push:
    branches: [main, develop]
    paths:
      - "todo.md" # ç›‘å¬ä½ çš„ todo.md
  workflow_dispatch:

jobs:
  codex-solve-tasks:
    runs-on: ubuntu-latest

    # å¿…é¡»èµ‹äºˆå†™æƒé™æ‰èƒ½æäº¤ä»£ç å’Œåˆ›å»º PR
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # èŽ·å–å®Œæ•´åŽ†å²ä»¥åˆ›å»ºåˆ†æ”¯
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Check for TODO tasks
        id: check-tasks
        run: |
          # ç®€å•æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¼€å‘æ ‡è®°
          if grep -q "\[ \].*å¾…å¼€å‘" todo.md; then
            echo "has_todos=true" >> $GITHUB_OUTPUT
            echo "âœ“ Found TODO tasks"
          else
            echo "has_todos=false" >> $GITHUB_OUTPUT
            echo "âœ“ No TODO tasks, skipping"
          fi

      - name: Create task branch
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          BRANCH_NAME="codex/solve-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Prepare Prompt & Context
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          # 1. è¯»å–åŸºç¡€ System Prompt
          cat .ai/codex.prompt.md > full_prompt.txt

          # 2. æ³¨å…¥ä»»åŠ¡å†…å®¹ (æå– new tasks)
          echo -e "\n\nã€æœ¬æ¬¡ä»»åŠ¡ã€‘\n" >> full_prompt.txt
          grep -A 20 "\[ \].*å¾…å¼€å‘" todo.md | head -50 >> full_prompt.txt

          # 3. æ³¨å…¥é¡¹ç›®ç»“æž„ (Context Packing)
          echo -e "\n\nã€é¡¹ç›®ç»“æž„ã€‘\n" >> full_prompt.txt
          find . -maxdepth 3 -not -path '*/.*' -not -path './node_modules*' >> full_prompt.txt

          # 4. æ³¨å…¥å…³é”®é…ç½®
          for f in package.json client/package.json; do
            if [ -f "$f" ]; then
              echo "### READ_ONLY_FILE: $f" >> full_prompt.txt
              cat "$f" >> full_prompt.txt
              echo "### END_READ_ONLY_FILE" >> full_prompt.txt
            fi
          done

      - name: Run Codex (API Implementation)
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          echo "Calling OpenAI API..."

          # æž„é€  Payload
          jq -n \
            --arg model "gpt-5-nano" \
            --rawfile input full_prompt.txt \
            --argjson store true \
            '{model: $model, input: $input, store: $store}' > payload.json
            
          # è°ƒç”¨ API
          curl https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d @payload.json > response.json

      - name: Apply Codex Solutions
        if: steps.check-tasks.outputs.has_todos == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            try {
              const rawData = fs.readFileSync('response.json', 'utf8');
              console.log("Raw API Response (truncated):", rawData.substring(0, 500) + "...");
              
              const response = JSON.parse(rawData);
              
              let aiText = "";
              // å¢žå¼ºçš„è§£æžé€»è¾‘ï¼Œé€‚é…å¤šç§ API è¿”å›žæ ¼å¼
              if (response.output && response.output.length > 0) {
                  const content = response.output[0].content || [];
                  aiText = content.map((item) => item?.text || "").join("");
              } else if (response.choices && response.choices.length > 0) {
                  aiText = response.choices[0].message?.content || "";
              } else if (response.text) {
                  aiText = response.text;
              }
              
              if (!aiText) {
                console.log("âš ï¸ No AI output found in response structure.");
                return;
              }
              
              console.log("AI Text length:", aiText.length);
              
              const fileRegex = /### FILE:\s*(.*?)\r?\n([\s\S]*?)### END_FILE/g;
              let match;
              let count = 0;
              while ((match = fileRegex.exec(aiText)) !== null) {
                const filePath = match[1].trim();
                const fileContent = match[2].replace(/\s+$/g, "");
                console.log(`Writing ${filePath}...`);
                const dir = path.dirname(filePath);
                if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                fs.writeFileSync(filePath, fileContent);
                count++;
              }
              console.log(`âœ… Successfully wrote ${count} files.`);
              
            } catch (e) {
              console.error("âŒ Failed to parse/write:", e);
            }

      - name: Commit and Push
        id: commit_changes
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          git config user.name "Codex Worker"
          git config user.email "codex@bot.com"

          # æ¸…ç†è°ƒè¯•æ–‡ä»¶ï¼Œé¿å…æäº¤åˆ°ä»“åº“
          rm -f full_prompt.txt payload.json response.json
          git rm -f --ignore-unmatch full_prompt.txt payload.json response.json

          git add .

          if ! git diff --cached --quiet; then
            git commit -m "feat: [Codex] implemented tasks from todo.md"
            git push origin "$BRANCH_NAME"
            echo "pushed=true" >> $GITHUB_OUTPUT
          else
            echo "No changes generated by Codex."
            echo "pushed=false" >> $GITHUB_OUTPUT
            exit 0 
          fi

      - name: Create Pull Request
        if: steps.check-tasks.outputs.has_todos == 'true' && steps.commit_changes.outputs.pushed == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY="## ðŸ¤– Codex Implementation Report

          This PR contains automated solutions for tasks in \`todo.md\`.

          **Status:** Ready for review.

          ---
          *Generated by Codex Worker*"

          gh pr create \
            --title "ðŸ¤– Codex Solutions - $(date +%Y%m%d-%H%M)" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME"
