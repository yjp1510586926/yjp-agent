name: Codex Worker

on:
  push:
    branches: [mainÔºådevelop]
    paths:
      - "todo.md" # ÁõëÂê¨‰Ω†ÁöÑ todo.md
  workflow_dispatch:

jobs:
  codex-solve-tasks:
    runs-on: ubuntu-latest

    # ÂøÖÈ°ªËµã‰∫àÂÜôÊùÉÈôêÊâçËÉΩÊèê‰∫§‰ª£Á†ÅÂíåÂàõÂª∫ PR
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤‰ª•ÂàõÂª∫ÂàÜÊîØ
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Check for TODO tasks
        id: check-tasks
        run: |
          # ÁÆÄÂçïÊ£ÄÊü•ÊòØÂê¶ÊúâÂæÖÂºÄÂèëÊ†áËÆ∞
          if grep -q "\[ \].*ÂæÖÂºÄÂèë" todo.md; then
            echo "has_todos=true" >> $GITHUB_OUTPUT
            echo "‚úì Found TODO tasks"
          else
            echo "has_todos=false" >> $GITHUB_OUTPUT
            echo "‚úì No TODO tasks, skipping"
          fi

      - name: Create task branch
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          BRANCH_NAME="codex/solve-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Prepare Prompt & Context
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          # 1. ËØªÂèñÂü∫Á°Ä System Prompt
          cat .ai/codex.prompt.md > full_prompt.txt

          # 2. Ê≥®ÂÖ•‰ªªÂä°ÂÜÖÂÆπ (ÊèêÂèñ new tasks)
          echo -e "\n\n„ÄêÊú¨Ê¨°‰ªªÂä°„Äë\n" >> full_prompt.txt
          grep -A 20 "\[ \].*ÂæÖÂºÄÂèë" todo.md | head -50 >> full_prompt.txt

          # 3. Ê≥®ÂÖ•È°πÁõÆÁªìÊûÑ (Context Packing)
          echo -e "\n\n„ÄêÈ°πÁõÆÁªìÊûÑ„Äë\n" >> full_prompt.txt
          find . -maxdepth 3 -not -path '*/.*' -not -path './node_modules*' >> full_prompt.txt

          # 4. Ê≥®ÂÖ•ÂÖ≥ÈîÆÈÖçÁΩÆ
          for f in package.json client/package.json; do
            if [ -f "$f" ]; then
              echo "### READ_ONLY_FILE: $f" >> full_prompt.txt
              cat "$f" >> full_prompt.txt
              echo "### END_READ_ONLY_FILE" >> full_prompt.txt
            fi
          done

      - name: Run Codex (API Implementation)
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          echo "Calling OpenAI API..."

          # ÊûÑÈÄ† Payload
          jq -n \
            --arg model "gpt-5-nano" \
            --rawfile input full_prompt.txt \
            --argjson store true \
            '{model: $model, input: $input, store: $store}' > payload.json
            
          # Ë∞ÉÁî® API
          curl https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d @payload.json > response.json

      - name: Apply Codex Solutions
        if: steps.check-tasks.outputs.has_todos == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            try {
              const rawData = fs.readFileSync('response.json', 'utf8');
              console.log("Raw API Response (truncated):", rawData.substring(0, 500) + "...");
              
              const response = JSON.parse(rawData);
              
              let aiText = "";
              // Â¢ûÂº∫ÁöÑËß£ÊûêÈÄªËæëÔºåÈÄÇÈÖçÂ§öÁßç API ËøîÂõûÊ†ºÂºè
              if (response.output && response.output.length > 0) {
                  aiText = response.output[0].content?.[0]?.text || "";
              } else if (response.choices && response.choices.length > 0) {
                  aiText = response.choices[0].message?.content || "";
              } else if (response.text) {
                  aiText = response.text;
              }
              
              if (!aiText) {
                console.log("‚ö†Ô∏è No AI output found in response structure.");
                return;
              }
              
              console.log("AI Text length:", aiText.length);
              
              const fileRegex = /### FILE: (.*?)\n([\s\S]*?)### END_FILE/g;
              let match;
              let count = 0;
              while ((match = fileRegex.exec(aiText)) !== null) {
                const filePath = match[1].trim();
                const fileContent = match[2].trim();
                console.log(`Writing ${filePath}...`);
                const dir = path.dirname(filePath);
                if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                fs.writeFileSync(filePath, fileContent);
                count++;
              }
              console.log(`‚úÖ Successfully wrote ${count} files.`);
              
            } catch (e) {
              console.error("‚ùå Failed to parse/write:", e);
            }

      - name: Commit and Push
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          git config user.name "Codex Worker"
          git config user.email "codex@bot.com"

          git add .

          if ! git diff --cached --quiet; then
            git commit -m "feat: [Codex] implemented tasks from todo.md"
            git push origin "$BRANCH_NAME"
          else
            echo "No changes generated by Codex."
            exit 0 
          fi

      - name: Create Pull Request
        if: steps.check-tasks.outputs.has_todos == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY="## ü§ñ Codex Implementation Report

          This PR contains automated solutions for tasks in \`todo.md\`.

          **Status:** Ready for review.

          ---
          *Generated by Codex Worker*"

          gh pr create \
            --title "ü§ñ Codex Solutions - $(date +%Y%m%d-%H%M)" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME"
