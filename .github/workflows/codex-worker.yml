name: Codex Worker

on:
  push:
    branches: [main]
    paths:
      - "todo.md" # ç›‘å¬ä½ çš„ todo.md
  workflow_dispatch:

jobs:
  codex-solve-tasks:
    runs-on: ubuntu-latest

    # å¿…é¡»èµ‹äºˆå†™æƒé™æ‰èƒ½æäº¤ä»£ç å’Œåˆ›å»º PR
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥åˆ›å»ºåˆ†æ”¯

      - name: Check for TODO tasks
        id: check-tasks
        run: |
          # ç®€å•æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¼€å‘æ ‡è®°
          if grep -q "\[ \].*å¾…å¼€å‘" todo.md; then
            echo "has_todos=true" >> $GITHUB_OUTPUT
            echo "âœ“ Found TODO tasks"
          else
            echo "has_todos=false" >> $GITHUB_OUTPUT
            echo "âœ“ No TODO tasks, skipping"
          fi

      - name: Create task branch
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          BRANCH_NAME="codex/solve-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Prepare Prompt & Context
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          # 1. è¯»å–åŸºç¡€ System Prompt
          cat .ai/codex.prompt.md > full_prompt.txt

          # 2. æ³¨å…¥ä»»åŠ¡å†…å®¹ (æå– new tasks)
          echo -e "\n\nã€æœ¬æ¬¡ä»»åŠ¡ã€‘\n" >> full_prompt.txt
          grep -A 20 "\[ \].*å¾…å¼€å‘" todo.md | head -50 >> full_prompt.txt

          # 3. æ³¨å…¥é¡¹ç›®ç»“æ„ (Context Packing)
          echo -e "\n\nã€é¡¹ç›®ç»“æ„ã€‘\n" >> full_prompt.txt
          find . -maxdepth 3 -not -path '*/.*' -not -path './node_modules*' >> full_prompt.txt

          # 4. æ³¨å…¥å…³é”®é…ç½®
          for f in package.json client/package.json; do
            if [ -f "$f" ]; then
              echo "### READ_ONLY_FILE: $f" >> full_prompt.txt
              cat "$f" >> full_prompt.txt
              echo "### END_READ_ONLY_FILE" >> full_prompt.txt
            fi
          done

      - name: Run Codex (API Implementation)
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          echo "Calling OpenAI API..."

          # æ„é€  Payload
          jq -n \
            --arg model "gpt-5-nano" \
            --rawfile input full_prompt.txt \
            --argjson store true \
            '{model: $model, input: $input, store: $store}' > payload.json
            
          # è°ƒç”¨ API
          curl https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d @payload.json > response.json

      - name: Apply Codex Solutions
        if: steps.check-tasks.outputs.has_todos == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            try {
              const response = JSON.parse(fs.readFileSync('response.json', 'utf8'));
              // å…¼å®¹ä¸åŒçš„ response ç»“æ„
              let aiText = "";
              if (response.output && response.output[0]) aiText = response.output[0].content[0].text;
              else if (response.choices && response.choices[0]) aiText = response.choices[0].message.content;
              else if (response.text) aiText = response.text; // æŸäº› API ç›´æ¥è¿”å› text
              
              if (!aiText) { console.log("No AI output found"); return; }
              
              const fileRegex = /### FILE: (.*?)\n([\s\S]*?)### END_FILE/g;
              let match;
              while ((match = fileRegex.exec(aiText)) !== null) {
                const filePath = match[1].trim();
                const fileContent = match[2].trim();
                console.log(`Writing ${filePath}...`);
                const dir = path.dirname(filePath);
                if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                fs.writeFileSync(filePath, fileContent);
              }
            } catch (e) {
              console.error("Failed to parse/write:", e);
              // ä¸é˜»æ–­æµç¨‹ï¼Œè®©ç©ºçš„ PR æš´éœ²é—®é¢˜
            }

      - name: Commit and Push
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          git config user.name "Codex Worker"
          git config user.email "codex@bot.com"

          git add .

          if ! git diff --cached --quiet; then
            git commit -m "feat: [Codex] implemented tasks from todo.md"
            git push origin "$BRANCH_NAME"
          else
            echo "No changes generated by Codex."
            exit 0 
          fi

      - name: Create Pull Request
        if: steps.check-tasks.outputs.has_todos == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY="## ğŸ¤– Codex Implementation Report

          This PR contains automated solutions for tasks in \`todo.md\`.

          **Status:** Ready for review.

          ---
          *Generated by Codex Worker*"

          gh pr create \
            --title "ğŸ¤– Codex Solutions - $(date +%Y%m%d-%H%M)" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME"
