name: Todo Changed - Trigger Codex

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "todo.md"

jobs:
  notify-codex:
    name: Notify Codex of Todo Changes
    runs-on: ubuntu-latest

    # æ·»åŠ æƒé™é…ç½®
    permissions:
      contents: read # è¯»å–ä»“åº“å†…å®¹
      issues: write # åˆ›å»ºå’Œç¼–è¾‘ Issues
      pull-requests: write # åˆ›å»ºè¯„è®ºï¼ˆå¯é€‰ï¼‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # éœ€è¦èŽ·å–å‰ä¸€æ¬¡æäº¤æ¥æ¯”è¾ƒå·®å¼‚

      - name: Get changed tasks
        id: changes
        run: |
          echo "Detecting changes in todo.md..."

          # èŽ·å–æœ¬æ¬¡æäº¤ä¸­ todo.md çš„å˜åŒ–
          git diff HEAD~1 HEAD -- todo.md > todo_diff.txt

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if [ -s todo_diff.txt ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Todo.md has changes"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes in todo.md"
          fi

      - name: Parse new tasks
        if: steps.changes.outputs.has_changes == 'true'
        id: parse
        run: |
          # æå–æ–°å¢žçš„ä»»åŠ¡ï¼ˆæ ‡è®°ä¸º"å¾…å¼€å‘"çš„ä»»åŠ¡ï¼‰
          # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®žé™…å¯ä»¥ç”¨æ›´å¤æ‚çš„è§£æž

          echo "Parsing new tasks from todo.md..."

          # è¯»å– todo.md å†…å®¹
          NEW_TASKS=$(grep -A 20 "å¾…å¼€å‘" todo.md | head -50 || echo "")

          if [ -n "$NEW_TASKS" ]; then
            echo "found_tasks=true" >> $GITHUB_OUTPUT
            echo "Found new tasks to develop"

            # ä¿å­˜ä»»åŠ¡ä¿¡æ¯ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
            echo "$NEW_TASKS" > new_tasks.txt
          else
            echo "found_tasks=false" >> $GITHUB_OUTPUT
            echo "No new tasks found"
          fi

      - name: Create Codex notification comment
        if: steps.parse.outputs.found_tasks == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // è¯»å– todo.md èŽ·å–ä»»åŠ¡è¯¦æƒ…
            const todoContent = fs.readFileSync('todo.md', 'utf8');

            // åˆ›å»ºä¸€ä¸ª issue æˆ–è¯„è®ºæ¥é€šçŸ¥ï¼ˆè¿™é‡Œåˆ›å»º issueï¼‰
            const issueBody = `## ðŸ¤– Codex å¼€å‘ä»»åŠ¡é€šçŸ¥

            æ£€æµ‹åˆ° \`todo.md\` æœ‰æ–°çš„å¼€å‘ä»»åŠ¡ã€‚

            ### ðŸ“‹ ä»»åŠ¡è¯¦æƒ…

            è¯·æŸ¥çœ‹ [todo.md](../blob/${context.sha}/todo.md) èŽ·å–å®Œæ•´çš„ä»»åŠ¡æè¿°ã€‚

            ### ðŸš€ ä¸‹ä¸€æ­¥

            **Codex è¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š**

            1. é˜…è¯» \`todo.md\` ä¸­æ ‡è®°ä¸º "å¾…å¼€å‘" çš„ä»»åŠ¡
            2. åˆ†æžä»»åŠ¡éœ€æ±‚
            3. åˆ›å»ºå¼€å‘åˆ†æ”¯ï¼š\`feature/task-[ä»»åŠ¡ç¼–å·]-[ç®€çŸ­æè¿°]\`
            4. æŒ‰ç…§ä»»åŠ¡è¦æ±‚å®žçŽ°ä»£ç 
            5. ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼ˆè¦†ç›–çŽ‡ > 80%ï¼‰
            6. æœ¬åœ°æµ‹è¯•é€šè¿‡åŽæäº¤ PR

            ### ðŸ“ å¼€å‘è§„èŒƒ

            - éµå¾ª [CLAUDE.md](../blob/main/CLAUDE.md) ä¸­çš„é¡¹ç›®è§„èŒƒ
            - å‚è€ƒ [å¼€å‘è®¡åˆ’æ¨¡æ¿](../blob/main/docs/templates/plan-template.md)
            - ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼
            - æ·»åŠ å®Œæ•´çš„é”™è¯¯å¤„ç†

            ### âœ… æäº¤è¦æ±‚

            - Commit message éµå¾ª Conventional Commits
            - PR æ ‡é¢˜æ ¼å¼ï¼š\`feat: [ä»»åŠ¡æ ‡é¢˜] (#ä»»åŠ¡ç¼–å·)\`
            - å¡«å†™å®Œæ•´çš„ PR æ¨¡æ¿
            - æ‰€æœ‰è‡ªåŠ¨åŒ–æ£€æŸ¥é€šè¿‡

            ---

            **æäº¤è€…**: @${context.actor}
            **æäº¤ SHA**: ${context.sha}
            **æ—¶é—´**: ${new Date().toISOString()}
            `;

            // åˆ›å»º issueï¼ˆæ ‡è®°ä¸º codex ä»»åŠ¡ï¼‰
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ¤– [Codex] æ–°çš„å¼€å‘ä»»åŠ¡',
              body: issueBody,
              labels: ['codex-task', 'auto-generated']
            });

      - name: Trigger AI Agent (Custom Config)
        if: steps.parse.outputs.found_tasks == 'true'
        run: |
          echo "Triggering AI Agent..."

          # Construct JSON payload securely using jq
          # Using the specific model and endpoint requested
          jq -n \
            --arg model "gpt-5-nano" \
            --rawfile input new_tasks.txt \
            --argjson store true \
            '{model: $model, input: $input, store: $store}' > payload.json
            
          # Execute the request
          curl https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d @payload.json

      - name: Upload todo.md as artifact
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: todo-md-${{ github.sha }}
          path: todo.md
          retention-days: 30
